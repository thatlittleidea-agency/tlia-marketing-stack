# =============================================================================
# TLIA Marketing Stack - Docker Compose Configuration (CHAS Stack)
# =============================================================================
# Domain: thatlittleidea.com
# Services: Mautic, N8N, Dolibarr, YOURLS, Metabase
# Voice: Retell AI (external service via webhooks)
# Optimized for 8GB RAM VPS
# =============================================================================

# =============================================================================
# SERVICES
# =============================================================================
services:

  # ---------------------------------------------------------------------------
  # MAUTIC - Marketing Automation Platform
  # Access: http://localhost:8080
  # ---------------------------------------------------------------------------
  mautic:
    image: mautic/mautic:latest
    container_name: tlia-mautic
    restart: unless-stopped
    ports:
      - "8080:80"
    environment:
      - MAUTIC_DB_HOST=mautic-db
      - MAUTIC_DB_NAME=mautic
      - MAUTIC_DB_USER=mautic
      - MAUTIC_DB_PASSWORD=${MAUTIC_DB_PASSWORD:-changeme}
      - MAUTIC_RUN_CRON_JOBS=true
      - TZ=${TZ:-America/Chicago}
    volumes:
      - mautic-data:/var/www/html
    depends_on:
      - mautic-db
    networks:
      - backend

  mautic-db:
    image: mysql:8.0
    container_name: tlia-mautic-db
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${MAUTIC_DB_ROOT_PASSWORD:-changeme}
      - MYSQL_DATABASE=mautic
      - MYSQL_USER=mautic
      - MYSQL_PASSWORD=${MAUTIC_DB_PASSWORD:-changeme}
      - TZ=${TZ:-America/Chicago}
    volumes:
      - mautic-db-data:/var/lib/mysql
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    networks:
      - backend

  # ---------------------------------------------------------------------------
  # N8N - Workflow Automation Tool
  # Access: http://localhost:5678
  # ---------------------------------------------------------------------------
  n8n:
    image: n8nio/n8n:latest
    container_name: tlia-n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD:-changeme}
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - GENERIC_TIMEZONE=${TZ:-America/Chicago}
      - TZ=${TZ:-America/Chicago}
    volumes:
      - n8n-data:/home/node/.n8n
      - ./recordings:/recordings
    networks:
      - backend

  # ---------------------------------------------------------------------------
  # DOLIBARR - ERP/CRM Platform (Replaces EspoCRM)
  # Access: http://localhost:8888
  # Configured for USD / Texas / USA
  # ---------------------------------------------------------------------------
  dolibarr:
    image: dolibarr/dolibarr:latest
    container_name: tlia-dolibarr
    restart: unless-stopped
    ports:
      - "8888:80"
    environment:
      - DOLI_DB_HOST=dolibarr-db
      - DOLI_DB_NAME=dolibarr
      - DOLI_DB_USER=dolibarr
      - DOLI_DB_PASSWORD=${DOLIBARR_DB_PASSWORD:-changeme}
      - DOLI_ADMIN_LOGIN=${DOLIBARR_ADMIN_USER:-admin}
      - DOLI_ADMIN_PASSWORD=${DOLIBARR_ADMIN_PASSWORD:-changeme}
      - DOLI_INIT_LANG=en_US
      - DOLI_INIT_CURRENCY=USD
      - DOLI_INIT_COUNTRY=US
      - DOLI_INIT_STATE=TX
      - TZ=${TZ:-America/Chicago}
    volumes:
      - dolibarr-data:/var/www/html/documents
      - dolibarr-custom:/var/www/html/custom
    depends_on:
      - dolibarr-db
    networks:
      backend:
        aliases:
          - tlia-dolibarr
    deploy:
      resources:
        limits:
          memory: 512M

  dolibarr-db:
    image: mariadb:10.11
    container_name: tlia-dolibarr-db
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${DOLIBARR_DB_ROOT_PASSWORD:-changeme}
      - MYSQL_DATABASE=dolibarr
      - MYSQL_USER=dolibarr
      - MYSQL_PASSWORD=${DOLIBARR_DB_PASSWORD:-changeme}
      - TZ=${TZ:-America/Chicago}
    volumes:
      - dolibarr-db-data:/var/lib/mysql
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    networks:
      - backend

  # ---------------------------------------------------------------------------
  # YOURLS - URL Shortener
  # Access: http://localhost:8181
  # ---------------------------------------------------------------------------
  yourls:
    image: yourls:latest
    container_name: tlia-yourls
    restart: unless-stopped
    ports:
      - "8181:8080"
    environment:
      - YOURLS_DB_HOST=yourls-db
      - YOURLS_DB_NAME=yourls
      - YOURLS_DB_USER=yourls
      - YOURLS_DB_PASS=${YOURLS_DB_PASSWORD:-changeme}
      - YOURLS_SITE=http://localhost:8181
      - YOURLS_USER=${YOURLS_USER:-admin}
      - YOURLS_PASS=${YOURLS_PASSWORD:-changeme}
      - TZ=${TZ:-America/Chicago}
    volumes:
      - yourls-data:/var/www/html
      - ./yourls/index.php:/var/www/html/index.php:ro
    depends_on:
      - yourls-db
    networks:
      - backend

  yourls-db:
    image: mysql:8.0
    container_name: tlia-yourls-db
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${YOURLS_DB_ROOT_PASSWORD:-changeme}
      - MYSQL_DATABASE=yourls
      - MYSQL_USER=yourls
      - MYSQL_PASSWORD=${YOURLS_DB_PASSWORD:-changeme}
      - TZ=${TZ:-America/Chicago}
    volumes:
      - yourls-db-data:/var/lib/mysql
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    networks:
      - backend

  # ---------------------------------------------------------------------------
  # METABASE - Business Intelligence & Dashboards
  # Access: http://localhost:3001
  # Memory capped at 2048MB for 8GB VPS stability
  # ---------------------------------------------------------------------------
  metabase:
    image: metabase/metabase:latest
    container_name: tlia-metabase
    restart: unless-stopped
    ports:
      - "3001:3000"
    environment:
      - MB_DB_TYPE=h2
      - MB_DB_FILE=/metabase-data/metabase.db
      - JAVA_TIMEZONE=${TZ:-America/Chicago}
      - JAVA_OPTS=-Xmx1500m
      - TZ=${TZ:-America/Chicago}
    volumes:
      - metabase-data:/metabase-data
    networks:
      - backend
    deploy:
      resources:
        limits:
          memory: 2048M

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  backend:
    name: backend
    driver: bridge

# =============================================================================
# VOLUMES - Named volumes for data persistence
# =============================================================================
volumes:
  # Mautic
  mautic-data:
    name: tlia-mautic-data
  mautic-db-data:
    name: tlia-mautic-db-data

  # N8N
  n8n-data:
    name: tlia-n8n-data

  # Dolibarr
  dolibarr-data:
    name: tlia-dolibarr-data
  dolibarr-custom:
    name: tlia-dolibarr-custom
  dolibarr-db-data:
    name: tlia-dolibarr-db-data

  # YOURLS
  yourls-data:
    name: tlia-yourls-data
  yourls-db-data:
    name: tlia-yourls-db-data

  # Metabase
  metabase-data:
    name: tlia-metabase-data

