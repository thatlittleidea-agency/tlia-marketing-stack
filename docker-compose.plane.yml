# =============================================================================
# TLIA Marketing Stack - Plane Project Management
# =============================================================================
# Domain: plane.thatlittleidea.com
# Plane.so - Open Source Project Management (Jira/Linear Alternative)
#
# IMPORTANT: Plane requires significant resources (4GB+ RAM recommended)
# Run separately from main stack: docker compose -f docker-compose.plane.yml up -d
# =============================================================================

x-app-env: &app-env
  WEB_URL: ${PLANE_WEB_URL:-http://localhost:8282}
  DEBUG: ${PLANE_DEBUG:-0}
  CORS_ALLOWED_ORIGINS: ${PLANE_WEB_URL:-http://localhost:8282}
  SENTRY_DSN: ""
  SENTRY_ENVIRONMENT: production
  SECRET_KEY: ${PLANE_SECRET_KEY:-tACFJhiHmv5HUksIeznn1Rbm8lGz5Anv}
  DATABASE_URL: postgresql://plane:${PLANE_DB_PASSWORD:-7g2CPcmSHzzlpFVL9i2QrfRI}@plane-db:5432/plane
  REDIS_URL: redis://plane-redis:6379/
  AMQP_URL: amqp://plane:${PLANE_MQ_PASSWORD:-i0XVkWG8r2jqHDNTUNeOo7J4}@plane-mq:5672/
  USE_MINIO: 1
  AWS_REGION: us-east-1
  AWS_ACCESS_KEY_ID: ${PLANE_MINIO_ROOT_USER:-PO8EcTcRyOGL3ZRj}
  AWS_SECRET_ACCESS_KEY: ${PLANE_MINIO_ROOT_PASSWORD:-iH5FNCtU74HtFFBqsCYwCgA0cOU3mMxJ}
  AWS_S3_ENDPOINT_URL: http://plane-minio:9000
  AWS_S3_BUCKET_NAME: uploads
  FILE_SIZE_LIMIT: 5242880
  GUNICORN_WORKERS: 1
  ENABLE_SIGNUP: ${PLANE_ENABLE_SIGNUP:-1}

services:

  # ---------------------------------------------------------------------------
  # PLANE DATABASE - PostgreSQL
  # ---------------------------------------------------------------------------
  plane-db:
    image: postgres:15.7-alpine
    container_name: tlia-plane-db
    restart: unless-stopped
    command: postgres -c 'max_connections=1000'
    environment:
      POSTGRES_USER: plane
      POSTGRES_PASSWORD: ${PLANE_DB_PASSWORD:-7g2CPcmSHzzlpFVL9i2QrfRI}
      POSTGRES_DB: plane
      PGDATA: /var/lib/postgresql/data
    volumes:
      - plane-db-data:/var/lib/postgresql/data
    networks:
      - plane-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U plane -d plane"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ---------------------------------------------------------------------------
  # PLANE CACHE - Redis (Valkey)
  # ---------------------------------------------------------------------------
  plane-redis:
    image: valkey/valkey:7.2.5-alpine
    container_name: tlia-plane-redis
    restart: unless-stopped
    volumes:
      - plane-redis-data:/data
    networks:
      - plane-network
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ---------------------------------------------------------------------------
  # PLANE MESSAGE QUEUE - RabbitMQ
  # ---------------------------------------------------------------------------
  plane-mq:
    image: rabbitmq:3.13.6-management-alpine
    container_name: tlia-plane-mq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: plane
      RABBITMQ_DEFAULT_PASS: ${PLANE_MQ_PASSWORD:-i0XVkWG8r2jqHDNTUNeOo7J4}
    volumes:
      - plane-mq-data:/var/lib/rabbitmq
    networks:
      - plane-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ---------------------------------------------------------------------------
  # PLANE STORAGE - MinIO
  # ---------------------------------------------------------------------------
  plane-minio:
    image: minio/minio:latest
    container_name: tlia-plane-minio
    restart: unless-stopped
    command: server /data --console-address ":9090"
    environment:
      MINIO_ROOT_USER: ${PLANE_MINIO_ROOT_USER:-PO8EcTcRyOGL3ZRj}
      MINIO_ROOT_PASSWORD: ${PLANE_MINIO_ROOT_PASSWORD:-iH5FNCtU74HtFFBqsCYwCgA0cOU3mMxJ}
    volumes:
      - plane-minio-data:/data
    networks:
      - plane-network

  # ---------------------------------------------------------------------------
  # PLANE API - Backend API Server
  # ---------------------------------------------------------------------------
  plane-api:
    image: artifacts.plane.so/makeplane/plane-backend:stable
    container_name: tlia-plane-api
    restart: unless-stopped
    command: ./bin/docker-entrypoint-api.sh
    environment:
      <<: *app-env
    depends_on:
      plane-db:
        condition: service_healthy
      plane-redis:
        condition: service_healthy
      plane-mq:
        condition: service_healthy
    networks:
      - plane-network

  # ---------------------------------------------------------------------------
  # PLANE WORKER - Background Job Processor
  # ---------------------------------------------------------------------------
  plane-worker:
    image: artifacts.plane.so/makeplane/plane-backend:stable
    container_name: tlia-plane-worker
    restart: unless-stopped
    command: ./bin/docker-entrypoint-worker.sh
    environment:
      <<: *app-env
    depends_on:
      - plane-api
    networks:
      - plane-network

  # ---------------------------------------------------------------------------
  # PLANE BEAT WORKER - Scheduled Task Processor
  # ---------------------------------------------------------------------------
  plane-beat-worker:
    image: artifacts.plane.so/makeplane/plane-backend:stable
    container_name: tlia-plane-beat-worker
    restart: unless-stopped
    command: ./bin/docker-entrypoint-beat.sh
    environment:
      <<: *app-env
    depends_on:
      - plane-api
    networks:
      - plane-network

  # ---------------------------------------------------------------------------
  # PLANE FRONTEND - Web Application
  # Access: http://localhost:8282
  # Production: plane.thatlittleidea.com
  # ---------------------------------------------------------------------------
  plane-frontend:
    image: artifacts.plane.so/makeplane/plane-frontend:stable
    container_name: tlia-plane-frontend
    restart: unless-stopped
    ports:
      - "8282:3000"
    environment:
      API_BASE_URL: http://plane-api:8000
    depends_on:
      - plane-api
    networks:
      - plane-network
      - backend

  # ---------------------------------------------------------------------------
  # PLANE LIVE - Real-time Collaboration
  # ---------------------------------------------------------------------------
  plane-live:
    image: artifacts.plane.so/makeplane/plane-live:stable
    container_name: tlia-plane-live
    restart: unless-stopped
    environment:
      API_BASE_URL: http://plane-api:8000
      REDIS_URL: redis://plane-redis:6379/
      LIVE_SERVER_SECRET_KEY: ${PLANE_SECRET_KEY:-tACFJhiHmv5HUksIeznn1Rbm8lGz5Anv}
    depends_on:
      - plane-api
      - plane-redis
    networks:
      - plane-network

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  plane-network:
    name: plane-network
    driver: bridge
  backend:
    external: true
    name: backend

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  plane-db-data:
    name: tlia-plane-db-data
  plane-redis-data:
    name: tlia-plane-redis-data
  plane-mq-data:
    name: tlia-plane-mq-data
  plane-minio-data:
    name: tlia-plane-minio-data
